---
title: "dge_analysis"
author: "mleukam"
date: "2019-09-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

clear the workspace
```{r}
rm(list = ls())
```

```{r}
library(tidyverse)
library(limma)
library(Biobase)
library(biomaRt)

```

Set default to not run chunks when knitting
(long operations in notebook make updating html output time prohibitive)
```{r}
knitr::opts_chunk$set(eval = FALSE)
```

Load data
```{r}
tcl_eset <- readRDS("output/tcl_eset.rds")
```

## Prepare expression data
```{r}
expr_matrix <- exprs(tcl_eset)
expr_matrix[1:5, 1:5]
```

Convert affymetrix probe IDs to gene symbols
```{r}
# note - takes up to 30+ minutes
mart <- useMart("ENSEMBL_MART_ENSEMBL")
mart <- useDataset("hsapiens_gene_ensembl", mart)
annotLookup <- getBM(
  mart = mart,
  attributes = c(
    "affy_hg_u133_plus_2",
    "ensembl_gene_id",
    "gene_biotype",
    "external_gene_name"),
  filter = "affy_hg_u133_plus_2",
  values = rownames(exprs(tcl_eset)),
  uniqueRows = TRUE)

# save for later use
saveRDS(annotLookup, "output/annotLookup.rds")
```

### Filtering 

#### Valid gene names
```{r}
# get lookup table
annotLookup <- readRDS("output/annotLookup.rds")

# apply new rownames
# keep only one entry per probe name
new_rnames <- rownames(expr_matrix) %>%
  enframe() %>%
  dplyr::select(affy_hg_u133_plus_2 = value) %>%
  left_join(annotLookup) %>%
  distinct(affy_hg_u133_plus_2, .keep_all = TRUE) %>%
  pull(external_gene_name) 
gnames_expr_matrix <- expr_matrix
rownames(gnames_expr_matrix) <- new_rnames

# remove "NA" gene names
dim(gnames_expr_matrix)
gnames_expr_matrix_nona <- gnames_expr_matrix %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene_name") %>%
  filter(gene_name != is.na(gene_name)) %>%
  column_to_rownames(var = "gene_name") %>%
  as.matrix()
gnames_expr_matrix_nona[1:5, 1:5]
dim(gnames_expr_matrix_nona)

# collapse identical gene names by averaging
dim(gnames_expr_matrix_nona)
expr_matrix_collapsed <- avereps(gnames_expr_matrix_nona)
dim(expr_matrix_collapsed)
```

#### Protein Coding
```{r}
summary(as.factor(annotLookup$gene_biotype))

dim(expr_matrix_collapsed)
expr_matrix_prtcode <- expr_matrix_collapsed %>%
  as.data.frame() %>%
  rownames_to_column(var = "external_gene_name") %>%
  as_tibble() %>%
  left_join(annotLookup) %>%
  distinct(external_gene_name, .keep_all = TRUE) %>%
  dplyr::filter(gene_biotype == "protein_coding") %>%
  dplyr::select(-affy_hg_u133_plus_2, 
                -ensembl_gene_id, 
                -gene_biotype) %>%
  as.data.frame() %>%
  column_to_rownames(var = "external_gene_name") %>%
  as.matrix()
dim(expr_matrix_prtcode)
```

#### Expression level
```{r}
pheno_data <- pData(tcl_eset)
summary(as.factor(pheno_data$collapsed_group))

median(expr_matrix_prtcode)
mean(expr_matrix_prtcode)

# filter out genes that aren't at least expressed greater than 1 in at least half of all cases
# total cases = 271
total_stats <- data.frame(
  total = apply(expr_matrix_prtcode, 1, 
                function(x) sum(x > 1, 
                                na.rm = TRUE)))
keep <- which(total_stats$total > 135) 

dim(expr_matrix_prtcode)
expr_matrix_filtered <- expr_matrix_prtcode[keep,]
dim(expr_matrix_filtered)
```

### Density Plot
```{r}
# tidy data
tidy_expr <- expr_matrix_filtered %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene_name") %>%
  as_tibble() %>%
  gather(key = "sampleID", value = "intensity", -gene_name) %>%
  print()

# plot
dplot_expr <- ggplot(tidy_expr, aes(intensity)) +
  geom_density() + 
  theme(legend.position = "none")
dplot_expr
```

### Normalize gene expression distributions

Normalisation by the method of trimmed mean of M-values (TMM) is performed using the calcNormFactors function in edgeR. The normalisation factors calculated here are used as a scaling factor for the library sizes. 

```{r}
# get normalization factors
norm_factors <- calcNormFactors(expr_matrix_filtered, method = "TMM")

# apply factor to each column
expr_matrix_norm <- map2_dfc(as.data.frame(expr_matrix_filtered),
                             norm_factors, `*`) %>%
  as.matrix()
rownames(expr_matrix_norm) <- rownames(expr_matrix_filtered)
expr_matrix_norm[1:5, 1:5]
```

## Define Groups

```{r}
# Get phenotype data from expressionset
pheno_data <- pData(tcl_eset)
str(pheno_data)

# create table with groups and potential batch effects as factors
pheno_tbl <- pheno_data %>%
  rownames_to_column(var = "sample_id") %>%
  as_tibble() %>%
  mutate(group = as.factor(collapsed_group),
         dataset = as.factor(dataset)) %>%
  print()

# Review group and potential batch effects
summary(pheno_tbl$group)
summary(pheno_tbl$dataset)
```

## Design and constrast matrices
```{r}
rnames <- pheno_tbl$sample_id
groups <- as.factor(pheno_tbl$group)
dataset <- as.factor(pheno_tbl$dataset)
design <- model.matrix(~ 0 + groups + dataset)
colnames(design) <- gsub("groups", "", colnames(design))
rownames(design) <- rnames
head(design)

contr.matrix <- makeContrasts(PTCL - control, levels = design)
head(contr.matrix)
```

## Limma

Fit linear models with limma
```{r}
# fit linear models
fit <- lmFit(expr_matrix_norm, design)
fit2 <- contrasts.fit(fit, contr.matrix)
fit2 <- eBayes(fit2)

summary(decideTests(fit2))

toptable_ptclvscontrol <- topTable(fit2, coef = 1, number = 'inf', sort.by = "P") %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene_symbol") %>%
  as_tibble() %>%
  print()

akt_expression <- toptable_ptclvscontrol %>% 
  dplyr::filter(gene_symbol == "AKT1") %>%
  print()
```
